#!/bin/sh

CONFIGURE=1

if [ ! -e /etc/ldap.conf ]; then
  echo " * WARNING: /etc/ldap.conf not exists, no configuring max-control"
  CONFIGURE=0
fi

if [ ! -e /etc/ldap.secret ]; then
  echo " * WARNING: /etc/ldap.secret not exists, no configuring max-control"
  CONFIGURE=0
fi

if [ "$(pidof slapd)" = "" ]; then
  echo " * WARNING: slapd is not running, no configuring max-control"
  CONFIGURE=0
fi


if ! grep -q ebox /etc/ldap.conf ; then
  echo " * WARNING: /etc/ldap.conf not configured for EBox/Zentyal"
  CONFIGURE=0
fi




if [ "$CONFIGURE" = "1" ]; then

    # create conf.inc.php from LDAP data 
    # (create max-control user or update-password)

    rm -f /etc/max-control/conf.inc.php
    (cd /usr/share/max-control && php init.php )

    chmod 640 /etc/max-control/conf.inc.php
    chown root:www-data /etc/max-control/conf.inc.php

    [ ! -e /var/lib/max-control/programer.ini ] && touch /var/lib/max-control/programer.ini
    chown www-data:www-data /var/lib/max-control/programer.ini
    # create empty log and chown www-data, fix #56
    touch /var/log/max-control-programer.log
    chown www-data:www-data /var/log/max-control-programer.log

    if [ -e /home/samba/netlogon/domain.txt ]; then
        chmod 644 /home/samba/netlogon/domain.txt
        unix2dos /home/samba/netlogon/domain.txt
    fi

    [ -d /var/lib/max-control/cache ] && chown www-data /var/lib/max-control/cache

    # create samba configuration
    echo " * Updating /etc/samba/max-control.conf"
    /usr/bin/pymaxgensamba

    # atftpd use /srv/tftp
    if [ ! -L /srv/tftp ]; then
        rmdir /srv/tftp >/dev/null 2>&1|| true
        ln -s /var/lib/tftpboot /srv/tftp
    fi

    # create PXE files
    /usr/bin/max-control pxe --genpxelinux

    # reset quotas
    #echo " * Reseting quotas"
    /usr/bin/reset-quotas || true

    # create quotas cache
    echo " * Updating Quota cache in /var/lib/max-control/quota.cache.php"
    /usr/bin/pyoverquota > /var/lib/max-control/quota.cache.php &
fi
