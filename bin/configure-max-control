#!/bin/sh

CONFIGURE=1

if [ ! -e /etc/ldap.conf ]; then
  echo " * WARNING: /etc/ldap.conf not exists, no configuring max-control"
  CONFIGURE=0
fi

if [ ! -e /etc/ldap.secret ]; then
  echo " * WARNING: /etc/ldap.secret not exists, no configuring max-control"
  CONFIGURE=0
fi

if [ "$(pidof samba)" = "" ]; then
  echo " * WARNING: samba is not running, no configuring max-control"
  CONFIGURE=0
fi


if ! grep -q zentyal /etc/ldap.conf ; then
  echo " * WARNING: /etc/ldap.conf not configured for Zentyal"
  CONFIGURE=0
fi

if ! getent group "Domain Admins" >/dev/null 2>&1; then
  echo " * WARNING: No 'Domain Admins' group found, is Samba+PAM enabled?"
  CONFIGURE=0
fi


if [ "$CONFIGURE" = "1" ]; then

    # populate LDAP Groups if "Domain Users" not found
    #if ! getent group "Domain Users" >/dev/null 2>&1; then
    #    echo " * Populating LDAP PDC groups...."
    #    [ -e /usr/share/zentyal-samba/enable-module ] && sudo -u ebox /usr/share/zentyal-samba/enable-module >/dev/null 2>&1
    #    [ -e /usr/share/ebox-samba/ebox-samba-enable ] && sudo -u ebox /usr/share/ebox-samba/ebox-samba-enable >/dev/null 2>&1
    #fi


    # create conf.inc.php from LDAP data 
    # (create max-control user or update-password)

    rm -f /etc/max-control/conf.inc.php
    (cd /usr/share/max-control && bash init.sh )

    chmod 640 /etc/max-control/conf.inc.php
    chown root:www-data /etc/max-control/conf.inc.php

    [ ! -e /var/lib/max-control/programer.ini ] && touch /var/lib/max-control/programer.ini
    chown www-data:www-data /var/lib/max-control/programer.ini
    # create empty log and chown www-data, fix #56
    touch /var/log/max-control-programer.log
    chown www-data:www-data /var/log/max-control-programer.log


    [ ! -e /var/lib/max-control/importer ] && mkdir -p /var/lib/max-control/importer
    chown www-data:www-data /var/lib/max-control/importer


    if [ -e /home/samba/netlogon/domain.txt ]; then
        chmod 644 /home/samba/netlogon/domain.txt
        unix2dos /home/samba/netlogon/domain.txt >/dev/null 2>&1
    fi

    [ -d /var/lib/max-control/cache ] && chown www-data /var/lib/max-control/cache

    # create samba configuration
    echo " * Updating /etc/samba/max-control.conf"
    /usr/bin/pymaxgensamba


    # create PXE files
    /usr/bin/max-control pxe --genpxelinux

    # reset quotas
    #echo " * Reseting quotas"
    /usr/bin/reset-quotas || true
fi
