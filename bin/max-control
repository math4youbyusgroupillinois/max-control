#!/bin/sh
#
#
#
#

HOMES_DIR=/home/samba/users/
PROFILES_DIR=/home/samba/profiles/
GROUPS_DIR=/home/samba/groups/

if [ "$1" = "createhome" ]; then
  # username
  NEWUSER=$2
  # quota in MB
  QUOTA=$3
  mkdir $HOMES_DIR/${NEWUSER}
  chown ${NEWUSER}:Domain\ Users ${HOMES_DIR}/${NEWUSER}
  chmod 701 ${HOMES_DIR}/${NEWUSER}

  # profile
  mkdir ${PROFILES_DIR}/${NEWUSER}
  chown ${NEWUSER}:Domain\ Users ${PROFILES_DIR}/${NEWUSER}
  chmod 701 ${PROFILES_DIR}/${NEWUSER}

  mkdir ${PROFILES_DIR}/${NEWUSER}.V2
  chown ${NEWUSER}:Domain\ Users ${PROFILES_DIR}/${NEWUSER}.V2
  chmod 701 ${PROFILES_DIR}/${NEWUSER}.V2
  

  # set quota
  /usr/share/ebox-samba/ebox-samba-quota -s ${NEWUSER} ${QUOTA}
  exit 0
fi

if [ "$1" = "deleteprofile" ]; then
  DELUSER=$2
  [ "${DELUSER}" = "" ] && ( echo "nonexists"; exit 1)
  rm -rf $HOMES_DIR/${DELUSER}
  rm -rf $PROFILES_DIR/${DELUSER}
  rm -rf $PROFILES_DIR/${DELUSER}.V2
  echo "ok"
  exit 0
fi


############################################################################

if [ "$1" = "addgroup" ]; then
  ADDGROUP=$2
  [ "${ADDGROUP}" = "" ] && ( echo "nonexists"; exit 1)
  mkdir -p ${GROUPS_DIR}/${ADDGROUP}
  chown root:${ADDGROUP} ${GROUPS_DIR}/${ADDGROUP}
  chmod +t ${GROUPS_DIR}/${ADDGROUP}
  chmod g+w ${GROUPS_DIR}/${ADDGROUP}
  echo "ok"
  exit 0
fi

if [ "$1" = "deletegroup" ]; then
  DELGROUP=$2
  [ "${DELGROUP}" = "" ] && ( echo "nonexists"; exit 1)
  rm -rf $GROUPS_DIR/${DELGROUP}
  echo "ok"
  exit 0
fi

############################################################################
if [ "getdefaultquota" = "$1" ]; then
  DEF=$(grep '"userquota_size"' /var/lib/ebox/gconf/ebox/modules/samba/GeneralSettings/%gconf.xml 2>/dev/null | awk -F '"' '{print $8}')

  if [ "DEF" = "" ]; then
    echo 500
  else
   echo $DEF
  fi
  exit 0
fi


############################################################################

if [ "$1" = "getdomainsid" ]; then
  net getdomainsid
  exit 0
fi


############################################################################


if [ "$1" = "genlogonshares" ]; then
  #pygenlogonshares 'ou=Groups,dc=max-server'
  pygenlogonshares "$2" > /home/samba/netlogon/shares.kix
  exit 0
fi


############################################################################
if [ "$1" = "pxe" ]; then
  args=$@
  ARGS=${args##pxe}
  pyboot ${ARGS}
  exit 0
fi
